apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: backing-services-api
  labels:
    heritage: deis-backing-services
spec:
  replicas: 1
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    type: RollingUpdate
  selector:
    matchLabels:
      app: backing-services-api
  template:
    metadata:
      labels:
        app: backing-services-api
    spec:
      containers:
        - name: backing-services-api
          image: "quay.io/codaisseur/deis-backing-services-api:{{ .Values.api.imageTag }}"
          imagePullPolicy: "Always"
          ports:
            - containerPort: 5000
              name: http
          env:
            - name: "DATABASE_URL"
              value: "postgres://{{ default "postgres" .Values.postgres.username }}:{{ .Values.postgres.password }}@postgres-pooling-service:5432/{{ .Values.postgres.database }}"
            - name: "MEMCACHED_SERVERS"
              value: "memcached-1,memcached-2"
            - name: "MONGODB_URL"
              value: "mongodb://root:{{ .Values.mongo.dbRootPassword }}@mongodb-service:27017/admin"
            - name: "PORT"
              value: "5000"
            - name: "RAILS_ENV"
              value: production
            - name: "RACK_ENV"
              value: production
            - name: "REDIS_URL"
              value: "redis://redis-sentinel:26379/redis_services"
            - name: "SECRET_KEY_BASE"
              valueFrom:
                secretKeyRef:
                  name: api
                  key: secretKeyBase
          livenessProbe:
            httpGet:
              path: /
              port: 5000
            initialDelaySeconds: 30
            timeoutSeconds: 1
          readinessProbe:
            httpGet:
              path: /
              port: 5000
            initialDelaySeconds: 30
            timeoutSeconds: 1
